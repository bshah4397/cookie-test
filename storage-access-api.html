<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cookie Setter</title>
  <script>

    function setCookie() {
      const value = document.getElementById("inputBox").value;
      document.cookie = `myCookie=${value}; path=/; SameSite=None; Secure`;
      showCookie();
    }

    function showCookie() {
      const name = "myCookie=";
      const decodedCookie = decodeURIComponent(document.cookie);
      document.getElementById("cc").innerText = decodedCookie;
    }

    function doThingsWithCookies() {
      document.cookie = "foo=bar; SameSite=None; Secure"; // set a cookie
      showCookie();
    }

    function doThingsWithLocalStorage(handle) {
      
      document.getElementById("cl").innerText = JSON.stringify(window.localStorage);

      if (handle) {
        const time = new Date().toTimeString();
        handle.localStorage.setItem(time, "1");
        console.log("Set localstorage");
        document.getElementById("pl").innerText = JSON.stringify(handle.localStorage);
      }

    }

    function doThingsWithSessionStorage(handle) {
      const session = JSON.stringify(window.sessionStorage);
      console.log("session", session);
      document.getElementById("cs").innerText = session;
      

      if (handle) {
        document.getElementById("ps").innerText = JSON.stringify(handle.sessionStorage);
      }
    }

    async function isSafari() {
      const userAgent = navigator.userAgent.toLowerCase();
      return userAgent.indexOf("safar") !== -1;
    }


    async function handleCookieAccess() {
      const btn = document.getElementById("btn");
      if (!document.hasStorageAccess) {
        // This browser doesn't support the Storage Access API
        // so let's just hope we have access!
        doThingsWithCookies();
      } else {
        const hasAccess = await document.hasStorageAccess();
        if (hasAccess) {
          // We have access to third-party cookies, so let's go
          doThingsWithCookies();
          // If we want to modify unpartitioned state, we need to request a handle.
          const handle = await document.requestStorageAccess({
            localStorage: true,
            sessionStorage: true,
          });
          doThingsWithLocalStorage(handle);
          doThingsWithSessionStorage(handle);
        } else {
          // Check whether third-party cookie access has been granted
          // to another same-site embed
          try {
            const permission = await navigator.permissions.query({
              name: "storage-access",
            });

            if (permission.state === "granted") {
              // If so, you can just call requestStorageAccess() without a user interaction,
              // and it will resolve automatically.
              const handle = await document.requestStorageAccess({
                cookies: true,
                localStorage: true,
                sessionStorage: true,
              });
              doThingsWithLocalStorage(handle);
              doThingsWithSessionStorage(handle);
              doThingsWithCookies();
            } else if (permission.state === "prompt") {
              // Need to call requestStorageAccess() after a user interaction
              btn.addEventListener("click", async () => {
                try {
                  const handle = await document.requestStorageAccess({
                    cookies: true,
                    localStorage: true,
                    sessionStorage: true,
                  });
                  doThingsWithLocalStorage(handle);
                  doThingsWithSessionStorage(handle);
                  doThingsWithCookies();
                } catch (err) {
                  // If there is an error obtaining storage access.
                  console.error(`Error obtaining storage access: ${err}.
                            Please sign in.`);
                }
              });
            } else if (permission.state === "denied") {
              // User has denied third-party cookie access, so we'll
              // need to do something else
            }
          } catch (error) {
            console.log(`Could not access permission state. Error: ${error}`);
            doThingsWithCookies(); // Again, we'll have to hope we have access!
          }
        }
      }
    }

  </script>
</head>

<body>
  <h1>Sample Cookie App using Storage Access API</h1>
  <div>
    <label for="inputBox">Enter value:</label>
    <input type="text" id="inputBox" />
    <button onclick="setCookie()">Set Cookie</button>
    <button onclick="handleCookieAccess()" id="btn">Request Cookie Access</button>
  </div>
  <br>
  <table border="2" width="100%">
    <tr>
      <th></th>
      <th>Cookie</th>
      <th>Session Storage</th>
      <th>Local Storage</th>
    </tr>
    <tr>
      <td>Current</td>
      <td id="cc">N/A</td>
      <td id="cs">N/A</td>
      <td id="cl">N/A</td>
    </tr>
    <tr>
      <td>Parent</td>
      <td id="pc">N/A</td>
      <td id="ps">N/A</td>
      <td id="pl">N/A</td>
    </tr>
  </table>
</body>

</html>
