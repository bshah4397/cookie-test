<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cookie Setter</title>
    <script>
      function setCookie() {
        const value = document.getElementById("inputBox").value;
        document.cookie = `myCookie=${value}; path=/; SameSite=None; Secure`;
        showCookie();
      }
 
      function showCookie() {
        const name = "myCookie=";
        const decodedCookie = decodeURIComponent(document.cookie);
        document.getElementById("cookieValue").innerText = decodedCookie;
        // const ca = decodedCookie.split(";");
        // for (let i = 0; i < ca.length; i++) {
        //   let c = ca[i];
        //   while (c.charAt(0) == " ") {
        //     c = c.substring(1);
        //   }
        //   if (c.indexOf(name) == 0) {
        //     document.getElementById("cookieValue").innerText = c.substring(
        //       name.length,
        //       c.length
        //     );
        //     return;
        //   }
        // }
        // document.getElementById("cookieValue").innerText = "Cookie not set";
      }

      function showSessionStorage() {
        const session = JSON.stringify(window.sessionStorage);
        document.getElementById("sessionValue").innerText = session;

        const parentSession = JSON.stringify(window.parent.sessionStorage);
        document.getElementById("parentSessionValue").innerText = parentSession;
      }

      function doThingsWithCookies() {
        document.cookie = "foo=bar; SameSite=None; Secure"; // set a cookie
        showCookie();
      }
      
      function doThingsWithLocalStorage(handle) {
        handle.localStorage.setItem("foo", "bar");
        console.log("Set localstorage - foo: bar");

        try { console.log("handle.parent.sessionStorage",JSON.stringify(handle.parent.sessionStorage)); }
        try { console.log("handle.sessionStorage",JSON.stringify(handle.sessionStorage)); }
        
      }

      async function isSafari() {
        const userAgent = navigator.userAgent.toLowerCase();
        return userAgent.indexOf("safar") !== -1;
      }
      
      async function handleCookieAccess() {
        if (!document.hasStorageAccess) {
          console.log("This browser doesn't support the Storage Access API, so let's just hope we have access!");
          doThingsWithCookies();
        } else {
          const hasAccess = await document.hasStorageAccess();
          console.log("hasAccess",hasAccess);
          if (hasAccess) {
            console.log("We have access to third-party cookies");
            doThingsWithCookies();
            // If we want to modify unpartitioned state, we need to request a handle.
            const handle = await document.requestStorageAccess({
              localStorage: true,
              sessionStorage: true,
            });
            console.log("Handle with local + session storage",handle);
            doThingsWithLocalStorage(handle);
          } else {
            if(isSafari()) {
              console.log("Browser is Safari");
              console.log("Calling requestStorageAccess()");
              const handle = await document.requestStorageAccess({
                    cookies: true,
                    localStorage: true,
                    sessionStorage: true,
                  });
              doThingsWithLocalStorage(handle);
              doThingsWithCookies();
            } else {
              console.log("Checking whether third-party cookie access has been granted to another same-site embed");
              try {
                const permission = await navigator.permissions.query({
                  name: "storage-access",
                });
        
                if (permission.state === "granted") {
                  console.log("Already granted, can directly call requestStorageAccess()");
                  // If so, you can just call requestStorageAccess() without a user interaction,
                  // and it will resolve automatically.
                  const handle = await document.requestStorageAccess({
                    cookies: true,
                    localStorage: true,
                    sessionStorage: true,
                  });
                  doThingsWithLocalStorage(handle);
                  doThingsWithCookies();
                } else if (permission.state === "prompt") {
                  console.log("User prompt - Need to call requestStorageAccess() after a user interaction");
                  // Need to call requestStorageAccess() after a user interaction
                  btn.addEventListener("click", async () => {
                    try {
                      const handle = await document.requestStorageAccess({
                        cookies: true,
                        localStorage: true,
                        sessionStorage: true,
                      });
                      doThingsWithLocalStorage(handle);
                      doThingsWithCookies();
                    } catch (err) {
                      console.log("error obtaining storage access");
                      // If there is an error obtaining storage access.
                      console.error(`Error obtaining storage access: ${err}.
                                    Please sign in.`);
                    }
                  });
                } else if (permission.state === "denied") {
                  console.log("User has denied third-party cookie access");
                  // User has denied third-party cookie access, so we'll
                  // need to do something else
                }
              } catch (error) {
                console.log("Could not access permission state");
                console.log(`Could not access permission state. Error: ${error}`);
                doThingsWithCookies(); // Again, we'll have to hope we have access!
              }
            }
            
          }
        }
        showSessionStorage();
      }
 
      window.onload = function () {
        showSessionStorage();
      };
    </script>
  </head>
  <body>
    <h1>Sample Cookie App using Storage Access API</h1>
    <div>
      <label for="inputBox">Enter value:</label>
      <input type="text" id="inputBox" />
      <button onclick="setCookie()">Set Cookie</button>
      <button onclick="handleCookieAccess()">Request Cookie Access</button>
    </div>
    <div id="cookieValue">Cookie not set</div>
    <div>iFrame Session Storage</div>
    <div id="sessionValue">Session Storage not set</div>
    <div>Parent Session Storage</div>
    <div id="parentSessionValue">Session Storage not set</div>
  </body>
</html>
